<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commerce Gyan - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        /* Login Page */
        .login-page { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .login-container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .error-msg { background: #fee; color: #c33; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; }
        
        /* Dashboard */
        .dashboard-page { display: none; }
        .header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 24px; color: #333; }
        .nav-tabs { background: white; padding: 15px; margin: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; gap: 10px; }
        .nav-tabs button { padding: 12px 24px; border: none; background: #f5f7fa; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .nav-tabs button:hover { background: #e5e7eb; }
        .nav-tabs button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .content { padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 32px; color: #667eea; margin-bottom: 8px; }
        .stat-card p { color: #666; font-size: 14px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h2 { margin-bottom: 20px; color: #333; font-size: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        
        /* Search & Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filters input, .filters select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        .filters input:focus, .filters select:focus { outline: none; border-color: #667eea; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        table th, table td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        table th { background: #f5f7fa; font-weight: 600; color: #333; }
        table tbody tr:hover { background: #f9fafb; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-block; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-info { background: #3b82f6; color: white; }
        .logout-btn { background: #ef4444; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        /* Views */
        .view { display: none; }
        .view.active { display: block; }
        
        /* Forms */
        .form-section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        
        /* Attendance Students */
        .attendance-student-item { padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e0e0e0; }
        .attendance-student-item:hover { border-color: #667eea; }
        .attendance-student-name { font-weight: 600; color: #333; }
        .attendance-student-phone { color: #666; font-size: 14px; margin-top: 3px; }
        .attendance-radio-group { display: flex; gap: 15px; }
        .attendance-radio-group label { cursor: pointer; padding: 5px 10px; border-radius: 6px; }
        .attendance-radio-group input[type="radio"] { margin-right: 5px; }
        
        /* Badges */
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        /* Alert */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs button { width: 100%; }
            .filters { flex-direction: column; }
            .filters input, .filters select { min-width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            table { font-size: 12px; }
            .attendance-student-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="logo">
                <h1>üéì Commerce Gyan</h1>
                <p>Admin Dashboard - Begusarai</p>
            </div>
            <div class="error-msg" id="errorMsg"></div>
            <form id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="admin@commercegyan.com" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn-login">Login to Dashboard</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="dashboard-page" id="dashboardPage">
        <div class="header">
            <h1>üéì Commerce Gyan - Admin Panel</h1>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="active" onclick="showView('dashboard')">üìä Dashboard</button>
            <button onclick="showView('students')">üë®‚Äçüéì Students</button>
            <button onclick="showView('fees')">üí∞ Fees</button>
            <button onclick="showView('batches')">üìö Batches</button>
            <button onclick="showView('attendance')">üìÖ Attendance</button>
            <button onclick="showView('enquiries')">üìû Enquiries</button>
        </div>

        <div class="content">
            <!-- DASHBOARD VIEW -->
            <div class="view active" id="dashboardView">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3 id="totalStudents">0</h3>
                        <p>üë®‚Äçüéì Total Students</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalFees">‚Çπ0</h3>
                        <p>üí∞ Total Fees Collected</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingFees">‚Çπ0</h3>
                        <p>‚è≥ Pending Fees</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalBatches">0</h3>
                        <p>üìö Active Batches</p>
                    </div>
                </div>

                <div class="card">
                    <h2>üìÖ Recent Activities</h2>
                    <div id="recentActivities">
                        <p style="text-align:center; color:#666; padding:20px;">Loading activities...</p>
                    </div>
                </div>
            </div>

            <!-- STUDENTS VIEW -->
            <div class="view" id="studentsView">
                <div class="card">
                    <div class="card-header">
                        <h2>üë®‚Äçüéì Students Management</h2>
                        <button class="btn btn-primary" onclick="toggleForm('studentForm')">+ Add New Student</button>
                    </div>

                    <div class="form-section" id="studentForm">
                        <h3 style="margin-bottom: 15px;">Add New Student</h3>
                        <form id="addStudentForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number *</label>
                                    <input type="tel" name="phone" required>
                                </div>
                                <div class="form-group">
                                    <label>Batch</label>
                                    <select name="batch_id" id="studentBatchSelect">
                                        <option value="">Select Batch</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Course Fee *</label>
                                    <input type="number" name="total_fee" required>
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" name="address">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Student</button>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="text" id="searchStudent" placeholder="üîç Search by name, phone or email..." onkeyup="filterStudents()">
                        <select id="filterBatch" onchange="filterStudents()">
                            <option value="">All Batches</option>
                        </select>
                        <select id="filterStatus" onchange="filterStudents()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Batch</th>
                                    <th>Total Fee</th>
                                    <th>Paid</th>
                                    <th>Due</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr><td colspan="9" style="text-align:center; padding:30px; color:#666;">Loading students...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FEES VIEW -->
            <div class="view" id="feesView">
                <div class="card">
                    <div class="card-header">
                        <h2>üí∞ Fees Management</h2>
                        <button class="btn btn-primary" onclick="toggleForm('feeForm')">+ Add Fee Payment</button>
                    </div>

                    <div class="form-section" id="feeForm">
                        <h3 style="margin-bottom: 15px;">Record Fee Payment</h3>
                        <form id="addFeeForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Select Student *</label>
                                    <select name="student_id" id="feeStudentSelect" required>
                                        <option value="">Select Student</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Amount Paid *</label>
                                    <input type="number" name="amount" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Payment Date *</label>
                                    <input type="date" name="payment_date" required>
                                </div>
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select name="payment_method">
                                        <option value="cash">Cash</option>
                                        <option value="upi">UPI</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="card">Card</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Remarks</label>
                                <textarea name="remarks" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Payment</button>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="text" id="searchFee" placeholder="üîç Search by student name..." onkeyup="filterFees()">
                        <select id="filterFeeMonth" onchange="filterFees()">
                            <option value="">All Months</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table id="feesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Phone</th>
                                    <th>Amount Paid</th>
                                    <th>Method</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="feesTableBody">
                                <tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">Loading fees...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BATCHES VIEW -->
            <div class="view" id="batchesView">
                <div class="card">
                    <div class="card-header">
                        <h2>üìö Batches Management</h2>
                        <button class="btn btn-primary" onclick="toggleForm('batchForm')">+ Create New Batch</button>
                    </div>

                    <div class="form-section" id="batchForm">
                        <h3 style="margin-bottom: 15px;">Create New Batch</h3>
                        <form id="addBatchForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Batch Name *</label>
                                    <input type="text" name="name" placeholder="e.g., Class 11 Commerce Morning" required>
                                </div>
                                <div class="form-group">
                                    <label>Course *</label>
                                    <input type="text" name="course" placeholder="e.g., Class 11 Commerce" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Timing *</label>
                                    <input type="text" name="timing" placeholder="e.g., 7:00 AM - 9:00 AM" required>
                                </div>
                                <div class="form-group">
                                    <label>Teacher Name</label>
                                    <input type="text" name="teacher">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea name="description" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Batch</button>
                        </form>
                    </div>

                    <div class="table-container">
                        <table id="batchesTable">
                            <thead>
                                <tr>
                                    <th>Batch Name</th>
                                    <th>Course</th>
                                    <th>Timing</th>
                                    <th>Teacher</th>
                                    <th>Students</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batchesTableBody">
                                <tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">Loading batches...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ATTENDANCE VIEW -->
            <div class="view" id="attendanceView">
                <div class="card">
                    <div class="card-header">
                        <h2>üìÖ Attendance Management</h2>
                        <button class="btn btn-primary" onclick="toggleForm('attendanceForm')">‚úì Mark Attendance</button>
                    </div>

                    <div class="form-section" id="attendanceForm">
                        <h3 style="margin-bottom: 15px;">Mark Attendance</h3>
                        <form id="markAttendanceForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" name="date" id="attendanceDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Select Batch *</label>
                                    <select name="batch_id" id="attendanceBatch" onchange="loadBatchStudentsForAttendance()" required>
                                        <option value="">Select Batch</option>
                                    </select>
                                </div>
                            </div>
                            <div id="attendanceStudentsList"></div>
                            <button type="submit" class="btn btn-primary" style="margin-top:15px;">Save Attendance</button>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="date" id="filterAttendanceDate" onchange="filterAttendance()">
                        <select id="filterAttendanceBatch" onchange="filterAttendance()">
                            <option value="">All Batches</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Batch</th>
                                    <th>Status</th>
                                    <th>Marked By</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">Loading attendance...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ENQUIRIES VIEW -->
            <div class="view" id="enquiriesView">
                <div class="card">
                    <div class="card-header">
                        <h2>üìû Enquiries</h2>
                    </div>

                    <div class="filters">
                        <input type="text" id="searchEnquiry" placeholder="üîç Search enquiries..." onkeyup="filterEnquiries()">
                        <select id="filterEnquiryStatus" onchange="filterEnquiries()">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="converted">Converted</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table id="enquiriesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Course</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enquiriesTableBody">
                                <tr><td colspan="8" style="text-align:center; padding:30px; color:#666;">Loading enquiries...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

        <script>
        // Global Variables
        let allStudents = [];
        let allFees = [];
        let allBatches = [];
        let allAttendance = [];
        let allEnquiries = [];
        const API_URL = 'https://commercegyan.onrender.com';

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if(response.ok && data.token) {
                    localStorage.setItem('adminToken', data.token);
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboardPage').style.display = 'block';
                    loadAllData();
                } else {
                    errorMsg.textContent = data.error || 'Invalid credentials';
                    errorMsg.style.display = 'block';
                }
            } catch(error) {
                errorMsg.textContent = 'Server error. Please try again.';
                errorMsg.style.display = 'block';
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // Check if already logged in
        window.onload = () => {
            const token = localStorage.getItem('adminToken');
            if(token) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                loadAllData();
            }
        };

        // Show View
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            event.target.classList.add('active');
        }

        // Toggle Form
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            form.style.display = form.style.display === 'none' || !form.style.display ? 'block' : 'none';
        }

        // Load All Data
        async function loadAllData() {
            const token = localStorage.getItem('adminToken');
            const headers = { 'Authorization': `Bearer ${token}` };

            try {
                const [students, fees, batches, attendance, enquiries] = await Promise.all([
                    fetch(`${API_URL}/api/admin/students`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/fees`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/batches`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/attendance`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/enquiries`, { headers }).then(r => r.json())
                ]);

                allStudents = students;
                allFees = fees;
                allBatches = batches;
                allAttendance = attendance;
                allEnquiries = enquiries;

                updateDashboard();
                renderStudents();
                renderFees();
                renderBatches();
                renderAttendance();
                renderEnquiries();
                populateDropdowns();
            } catch(error) {
                console.error('Error loading ', error);
                alert('Failed to load data. Please refresh the page.');
            }
        }

        // Update Dashboard Stats
        function updateDashboard() {
            document.getElementById('totalStudents').textContent = allStudents.length;
            
            const totalFees = allFees.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
            document.getElementById('totalFees').textContent = '‚Çπ' + totalFees.toLocaleString('en-IN');
            
            const totalDue = allStudents.reduce((sum, s) => {
                const paid = allFees.filter(f => f.student_id === s.id).reduce((p, f) => p + parseFloat(f.amount), 0);
                return sum + (parseFloat(s.total_fee || 0) - paid);
            }, 0);
            document.getElementById('pendingFees').textContent = '‚Çπ' + totalDue.toLocaleString('en-IN');
            
            document.getElementById('totalBatches').textContent = allBatches.filter(b => b.status === 'active').length;

            // Recent Activities
            const activities = document.getElementById('recentActivities');
            const recentFees = allFees.slice(-5).reverse();
            if(recentFees.length === 0) {
                activities.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No recent activities</p>';
            } else {
                activities.innerHTML = recentFees.map(f => {
                    const student = allStudents.find(s => s.id === f.student_id);
                    return `<p style="padding:10px; border-bottom:1px solid #e0e0e0;">üí∞ ${student?.name || 'Unknown'} paid ‚Çπ${f.amount} on ${new Date(f.payment_date).toLocaleDateString()}</p>`;
                }).join('');
            }
        }

        // Populate Dropdowns
        function populateDropdowns() {
            const batchSelects = [
                document.getElementById('studentBatchSelect'),
                document.getElementById('filterBatch'),
                document.getElementById('attendanceBatch'),
                document.getElementById('filterAttendanceBatch')
            ];

            batchSelects.forEach(select => {
                if(select) {
                    const currentValue = select.value;
                    const options = select.id.includes('filter') 
                        ? '<option value="">All Batches</option>' 
                        : '<option value="">Select Batch</option>';
                    
                    select.innerHTML = options + allBatches.map(b => 
                        `<option value="${b.id}">${b.name}</option>`
                    ).join('');
                    
                    if(currentValue) select.value = currentValue;
                }
            });

            const studentSelect = document.getElementById('feeStudentSelect');
            if(studentSelect) {
                studentSelect.innerHTML = '<option value="">Select Student</option>' + 
                    allStudents.map(s => `<option value="${s.id}">${s.name} (${s.phone})</option>`).join('');
            }

            const monthSelect = document.getElementById('filterFeeMonth');
            if(monthSelect && allFees.length > 0) {
                const months = [...new Set(allFees.map(f => new Date(f.payment_date).toLocaleDateString('en-IN', {month: 'long', year: 'numeric'})))];
                monthSelect.innerHTML = '<option value="">All Months</option>' + 
                    months.map(m => `<option value="${m}">${m}</option>`).join('');
            }
        }

        // Render Students
        function renderStudents(filteredData = null) {
            const students = filteredData || allStudents;
            const tbody = document.getElementById('studentsTableBody');
            
            if(students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#666;">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(s => {
                const paid = allFees.filter(f => f.student_id === s.id).reduce((sum, f) => sum + parseFloat(f.amount), 0);
                const due = (parseFloat(s.total_fee) || 0) - paid;
                const batch = allBatches.find(b => b.id === s.batch_id);
                
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.phone}</td>
                        <td>${s.email || '-'}</td>
                        <td>${batch?.name || 'Not Assigned'}</td>
                        <td>‚Çπ${parseFloat(s.total_fee || 0).toLocaleString('en-IN')}</td>
                        <td>‚Çπ${paid.toLocaleString('en-IN')}</td>
                        <td>‚Çπ${due.toLocaleString('en-IN')}</td>
                        <td><span class="badge ${s.status === 'active' ? 'badge-success' : 'badge-danger'}">${s.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editStudent(${s.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Students
        function filterStudents() {
            const search = document.getElementById('searchStudent').value.toLowerCase();
            const batch = document.getElementById('filterBatch').value;
            const status = document.getElementById('filterStatus').value;

            const filtered = allStudents.filter(s => {
                const matchSearch = s.name.toLowerCase().includes(search) || 
                                  s.phone.includes(search) || 
                                  (s.email && s.email.toLowerCase().includes(search));
                const matchBatch = !batch || s.batch_id === batch;
                const matchStatus = !status || s.status === status;
                return matchSearch && matchBatch && matchStatus;
            });

            renderStudents(filtered);
        }

        // Add Student
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${API_URL}/api/admin/students`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(data)
                });

                if(response.ok) {
                    alert('Student added successfully!');
                    e.target.reset();
                    toggleForm('studentForm');
                    loadAllData();
                } else {
                    alert('Failed to add student');
                }
            } catch(error) {
                alert('Error adding student');
            }
        });

        // Delete Student
        async function deleteStudent(id) {
            if(!confirm('Are you sure you want to delete this student?')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/students/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });

                if(response.ok) {
                    alert('Student deleted successfully!');
                    loadAllData();
                } else {
                    alert('Failed to delete student');
                }
            } catch(error) {
                alert('Error deleting student');
            }
        }

        // Render Fees
        function renderFees(filteredData = null) {
            const fees = filteredData || allFees;
            const tbody = document.getElementById('feesTableBody');
            
            if(fees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">No fee records found</td></tr>';
                return;
            }

            tbody.innerHTML = fees.slice().reverse().map(f => {
                const student = allStudents.find(s => s.id === f.student_id);
                return `
                    <tr>
                        <td>${new Date(f.payment_date).toLocaleDateString('en-IN')}</td>
                        <td>${student?.name || 'Unknown'}</td>
                        <td>${student?.phone || '-'}</td>
                        <td>‚Çπ${parseFloat(f.amount).toLocaleString('en-IN')}</td>
                        <td><span class="badge badge-info">${f.payment_method}</span></td>
                        <td>${f.remarks || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteFee(${f.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Fees
        function filterFees() {
            const search = document.getElementById('searchFee').value.toLowerCase();
            const month = document.getElementById('filterFeeMonth').value;

            const filtered = allFees.filter(f => {
                const student = allStudents.find(s => s.id === f.student_id);
                const matchSearch = student?.name.toLowerCase().includes(search);
                const matchMonth = !month || new Date(f.payment_date).toLocaleDateString('en-IN', {month: 'long', year: 'numeric'}) === month;
                return matchSearch && matchMonth;
            });

            renderFees(filtered);
        }

        // Add Fee
        document.getElementById('addFeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${API_URL}/api/admin/fees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(data)
                });

                if(response.ok) {
                    alert('Fee payment recorded successfully!');
                    e.target.reset();
                    toggleForm('feeForm');
                    loadAllData();
                } else {
                    alert('Failed to record payment');
                }
            } catch(error) {
                alert('Error recording payment');
            }
        });

        // Delete Fee
        async function deleteFee(id) {
            if(!confirm('Are you sure you want to delete this fee record?')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/fees/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });

                if(response.ok) {
                    alert('Fee record deleted successfully!');
                    loadAllData();
                } else {
                    alert('Failed to delete fee record');
                }
            } catch(error) {
                alert('Error deleting fee record');
            }
        }

        // Render Batches
        function renderBatches() {
            const tbody = document.getElementById('batchesTableBody');
            
            if(allBatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">No batches found</td></tr>';
                return;
            }

            tbody.innerHTML = allBatches.map(b => {
                const studentCount = allStudents.filter(s => s.batch_id === b.id).length;
                return `
                    <tr>
                        <td>${b.name}</td>
                        <td>${b.course || '-'}</td>
                        <td>${b.timing || '-'}</td>
                        <td>${b.teacher || '-'}</td>
                        <td>${studentCount}</td>
                        <td><span class="badge ${b.status === 'active' ? 'badge-success' : 'badge-danger'}">${b.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editBatch(${b.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBatch(${b.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add Batch
        document.getElementById('addBatchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${API_URL}/api/admin/batches`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(data)
                });

                if(response.ok) {
                    alert('Batch created successfully!');
                    e.target.reset();
                    toggleForm('batchForm');
                    loadAllData();
                } else {
                    alert('Failed to create batch');
                }
            } catch(error) {
                alert('Error creating batch');
            }
        });

        // Delete Batch
        async function deleteBatch(id) {
            if(!confirm('Are you sure you want to delete this batch?')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/batches/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });

                if(response.ok) {
                    alert('Batch deleted successfully!');
                    loadAllData();
                } else {
                    alert('Failed to delete batch');
                }
            } catch(error) {
                alert('Error deleting batch');
            }
        }

        // Load Batch Students for Attendance (FIXED VERSION)
        window.loadBatchStudentsForAttendance = () => {
            const batchId = document.getElementById('attendanceBatch').value;
            const container = document.getElementById('attendanceStudentsList');
            
            console.log('=== ATTENDANCE DEBUG ===');
            console.log('Selected Batch ID:', batchId);
            console.log('All Students:', allStudents);
            console.log('All Batches:', allBatches);
            
            if(!batchId) {
                container.innerHTML = '<p style="padding:20px; text-align:center; color:#666;">Please select a batch to see students</p>';
                return;
            }

            let students = allStudents.filter(s => {
                const matchesBatch = (s.batch_id === batchId) || (s.batch === batchId);
                const isActive = (s.status === 'active') || (!s.status);
                return matchesBatch && isActive;
            });
            
            console.log('Students in selected batch:', students);
            
            if(students.length === 0) {
                console.log('No students in batch - showing all students');
                students = allStudents.filter(s => (s.status === 'active') || (!s.status));
                
                if(students.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è No students found!</strong><br>
                            Please add students first from the Students section.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="alert alert-warning" style="background:#fef3c7; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #f59e0b;">
                        <strong>‚ö†Ô∏è No students assigned to this batch yet</strong><br>
                        Showing all students below. Please assign students to batches from Students section for accurate attendance.
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }

            container.innerHTML += '<h4 style="margin:15px 0; color:#333;">Mark Attendance for ' + students.length + ' Students:</h4>';
            
            students.forEach(s => {
                const studentBatch = allBatches.find(b => b.id === s.batch_id);
                const batchName = studentBatch ? studentBatch.name : 'No Batch Assigned';
                
                container.innerHTML += `
                    <div class="attendance-student-item">
                        <div>
                            <div class="attendance-student-name">${s.name}</div>
                            <div class="attendance-student-phone">üì± ${s.phone} | üìö ${batchName}</div>
                        </div>
                        <div class="attendance-radio-group">
                            <label>
                                <input type="radio" name="att_${s.id}" value="present" checked> 
                                ‚úì Present
                            </label>
                            <label>
                                <input type="radio" name="att_${s.id}" value="absent"> 
                                ‚úó Absent
                            </label>
                        </div>
                    </div>
                `;
            });
        };

        // Mark Attendance
        document.getElementById('markAttendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('attendanceDate').value;
            const batchId = document.getElementById('attendanceBatch').value;

            if(!date || !batchId) {
                alert('Please select date and batch');
                return;
            }

            const attendanceData = [];
            const radios = document.querySelectorAll('[name^="att_"]');
            const studentIds = [...new Set([...radios].map(r => r.name.replace('att_', '')))];

            studentIds.forEach(studentId => {
                const status = document.querySelector(`[name="att_${studentId}"]:checked`)?.value || 'absent';
                attendanceData.push({
                    student_id: studentId,
                    batch_id: batchId,
                    date: date,
                    status: status
                });
            });

            try {
                const response = await fetch(`${API_URL}/api/admin/attendance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ attendance: attendanceData })
                });

                if(response.ok) {
                    alert('Attendance marked successfully!');
                    e.target.reset();
                    toggleForm('attendanceForm');
                    loadAllData();
                } else {
                    alert('Failed to mark attendance');
                }
            } catch(error) {
                alert('Error marking attendance');
            }
        });

        // Render Attendance
        function renderAttendance(filteredData = null) {
            const attendance = filteredData || allAttendance;
            const tbody = document.getElementById('attendanceTableBody');
            
            if(attendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">No attendance records found</td></tr>';
                return;
            }

            tbody.innerHTML = attendance.slice().reverse().map(a => {
                const student = allStudents.find(s => s.id == a.student_id);
                const batch = allBatches.find(b => b.id == a.batch_id);
                return `
                    <tr>
                        <td>${new Date(a.date).toLocaleDateString('en-IN')}</td>
                        <td>${student?.name || 'Unknown'}</td>
                        <td>${batch?.name || 'Unknown'}</td>
                        <td><span class="badge ${a.status === 'present' ? 'badge-success' : 'badge-danger'}">${a.status}</span></td>
                        <td>Admin</td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Attendance
        function filterAttendance() {
            const date = document.getElementById('filterAttendanceDate').value;
            const batch = document.getElementById('filterAttendanceBatch').value;

            const filtered = allAttendance.filter(a => {
                const matchDate = !date || a.date === date;
                const matchBatch = !batch || a.batch_id == batch;
                return matchDate && matchBatch;
            });

            renderAttendance(filtered);
        }

        // Render Enquiries
        function renderEnquiries(filteredData = null) {
            const enquiries = filteredData || allEnquiries;
            const tbody = document.getElementById('enquiriesTableBody');
            
            if(enquiries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px; color:#666;">No enquiries found</td></tr>';
                return;
            }

            tbody.innerHTML = enquiries.slice().reverse().map(e => {
                return `
                    <tr>
                        <td>${new Date(e.created_at).toLocaleDateString('en-IN')}</td>
                        <td>${e.name}</td>
                        <td>${e.phone}</td>
                        <td>${e.email || '-'}</td>
                        <td>${e.course || '-'}</td>
                        <td>${e.message || '-'}</td>
                        <td><span class="badge badge-${e.status === 'new' ? 'warning' : e.status === 'converted' ? 'success' : 'info'}">${e.status || 'new'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="updateEnquiryStatus(${e.id}, 'contacted')">Contact</button>
                            <button class="btn btn-sm btn-info" onclick="updateEnquiryStatus(${e.id}, 'converted')">Convert</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Enquiries
        function filterEnquiries() {
            const search = document.getElementById('searchEnquiry').value.toLowerCase();
            const status = document.getElementById('filterEnquiryStatus').value;

            const filtered = allEnquiries.filter(e => {
                const matchSearch = e.name.toLowerCase().includes(search) || 
                                  e.phone.includes(search) || 
                                  (e.email && e.email.toLowerCase().includes(search));
                const matchStatus = !status || e.status === status;
                return matchSearch && matchStatus;
            });

            renderEnquiries(filtered);
        }

        // Update Enquiry Status
        async function updateEnquiryStatus(id, status) {
            try {
                const response = await fetch(`${API_URL}/api/admin/enquiries/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ status })
                });

                if(response.ok) {
                    alert('Enquiry status updated!');
                    loadAllData();
                } else {
                    alert('Failed to update status');
                }
            } catch(error) {
                alert('Error updating status');
            }
        }

        // Set today's date as default for attendance
        document.getElementById('attendanceDate').valueAsDate = new Date();
    </script>
</body>
</html>
