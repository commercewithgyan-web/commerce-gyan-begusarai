<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commerce Gyan - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        /* Login Page */
        .login-page { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .login-container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .error-msg { background: #fee; color: #c33; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; }
        
        /* Dashboard */
        .dashboard-page { display: none; }
        .header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 24px; color: #333; }
        .nav-tabs { background: white; padding: 15px; margin: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; gap: 10px; }
        .nav-tabs button { padding: 12px 24px; border: none; background: #f5f7fa; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .nav-tabs button:hover { background: #e5e7eb; }
        .nav-tabs button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .content { padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 32px; color: #667eea; margin-bottom: 8px; }
        .stat-card p { color: #666; font-size: 14px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h2 { margin-bottom: 20px; color: #333; font-size: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        
        /* Search & Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filters input, .filters select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        .filters input:focus, .filters select:focus { outline: none; border-color: #667eea; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        table th, table td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        table th { background: #f5f7fa; font-weight: 600; color: #333; position: sticky; top: 0; }
        table tbody tr:hover { background: #f9fafb; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-block; text-decoration: none; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-info { background: #3b82f6; color: white; }
        .logout-btn { background: #ef4444; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        /* Views */
        .view { display: none; }
        .view.active { display: block; }
        
        /* Forms */
        .form-section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        
        /* Attendance Students List */
        .attendance-student-item { padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e0e0e0; }
        .attendance-student-item:hover { border-color: #667eea; }
        .attendance-student-name { font-weight: 600; color: #333; }
        .attendance-student-phone { color: #666; font-size: 14px; margin-top: 3px; }
        .attendance-radio-group { display: flex; gap: 15px; }
        .attendance-radio-group label { cursor: pointer; padding: 5px 10px; border-radius: 6px; transition: all 0.3s; }
        .attendance-radio-group input[type="radio"] { margin-right: 5px; }
        .attendance-radio-group label:has(input:checked) { background: #667eea; color: white; }
        
        /* Badges */
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        /* Alert */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
            .nav-tabs button { width: 100%; }
            .filters { flex-direction: column; }
            .filters input, .filters select { min-width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            table { font-size: 12px; min-width: 600px; }
            .attendance-student-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="logo">
                <h1>üéì Commerce Gyan</h1>
                <p>Admin Dashboard - Begusarai</p>
            </div>
            <div class="error-msg" id="errorMsg"></div>
            <form id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="admin@commercegyan.com" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn-login">Login to Dashboard</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="dashboard-page" id="dashboardPage">
        <div class="header">
            <h1>üéì Commerce Gyan - Admin Panel</h1>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="active" onclick="showView('dashboard')">üìä Dashboard</button>
            <button onclick="showView('students')">üë®‚Äçüéì Students</button>
            <button onclick="showView('fees')">üí∞ Fees</button>
            <button onclick="showView('batches')">üìö Batches</button>
            <button onclick="showView('attendance')">üìÖ Attendance</button>
            <button onclick="showView('enquiries')">üìû Enquiries</button>
        </div>

        <div class="content">
            <!-- DASHBOARD VIEW -->
            <div id="dashboardView" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalStudents">0</h3>
                        <p>üë®‚Äçüéì Total Students</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalRevenue">‚Çπ0</h3>
                        <p>üí∞ Total Revenue</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingFees">‚Çπ0</h3>
                        <p>‚è≥ Pending Fees</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalBatches">0</h3>
                        <p>üìö Active Batches</p>
                    </div>
                </div>

                <div class="card">
                    <h2>üìä Quick Overview</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="padding: 15px; background: #f0fdf4; border-radius: 8px;">
                            <p style="color: #666; font-size: 14px;">This Month Collection</p>
                            <h3 style="color: #10b981; font-size: 24px; margin-top: 5px;" id="monthCollection">‚Çπ0</h3>
                        </div>
                        <div style="padding: 15px; background: #fef2f2; border-radius: 8px;">
                            <p style="color: #666; font-size: 14px;">Defaulters</p>
                            <h3 style="color: #ef4444; font-size: 24px; margin-top: 5px;" id="defaultersCount">0</h3>
                        </div>
                        <div style="padding: 15px; background: #eff6ff; border-radius: 8px;">
                            <p style="color: #666; font-size: 14px;">New Enquiries</p>
                            <h3 style="color: #3b82f6; font-size: 24px; margin-top: 5px;" id="newEnquiries">0</h3>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Recent Students</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Student ID</th><th>Name</th><th>Phone</th><th>Class</th><th>Balance</th><th>Status</th></tr>
                            </thead>
                            <tbody id="recentStudentsTable">
                                <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- STUDENTS VIEW -->
            <div id="studentsView" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2>üë®‚Äçüéì Student Management</h2>
                        <button class="btn btn-primary" onclick="showAddStudent()">+ Add Student</button>
                    </div>
                    
                    <div id="addStudentForm" class="form-section">
                        <h3>Add New Student</h3>
                        <form id="studentForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Student Name *</label>
                                    <input type="text" id="studentName" required placeholder="Enter full name">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number *</label>
                                    <input type="tel" id="studentPhone" required placeholder="10-digit mobile" pattern="[0-9]{10}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Parent Name</label>
                                    <input type="text" id="parentName" placeholder="Father/Mother name">
                                </div>
                                <div class="form-group">
                                    <label>Parent Phone</label>
                                    <input type="tel" id="parentPhone" placeholder="Parent contact" pattern="[0-9]{10}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Class *</label>
                                    <select id="studentClass" required>
                                        <option value="">Select Class</option>
                                        <option value="11">Class 11</option>
                                        <option value="12">Class 12</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Batch</label>
                                    <select id="studentBatch">
                                        <option value="">Select Batch (Optional)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Monthly Fee (‚Çπ) *</label>
                                    <input type="number" id="monthlyFee" required placeholder="e.g., 1500">
                                </div>
                                <div class="form-group">
                                    <label>Admission Date *</label>
                                    <input type="date" id="admissionDate" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <textarea id="studentAddress" rows="2" placeholder="Enter complete address"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">üíæ Save Student</button>
                            <button type="button" class="btn" onclick="hideAddStudent()">Cancel</button>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="text" id="searchStudent" placeholder="üîç Search by name or phone...">
                        <select id="filterClass">
                            <option value="">All Classes</option>
                            <option value="11">Class 11</option>
                            <option value="12">Class 12</option>
                        </select>
                        <select id="filterBatch">
                            <option value="">All Batches</option>
                        </select>
                        <select id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th><th>Name</th><th>Phone</th><th>Class</th><th>Batch</th>
                                    <th>Monthly Fee</th><th>Balance</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable">
                                <tr><td colspan="9" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FEES VIEW -->
            <div id="feesView" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2>üí∞ Fee Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showCollectFee()">+ Collect Fee</button>
                        </div>
                    </div>

                    <div id="collectFeeForm" class="form-section">
                        <h3>Collect Fee Payment</h3>
                        <form id="feeForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Select Student *</label>
                                    <select id="feeStudentId" required onchange="fillStudentFee()">
                                        <option value="">-- Select Student --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Month *</label>
                                    <input type="month" id="feeMonth" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Amount (‚Çπ) *</label>
                                    <input type="number" id="feeAmount" required>
                                </div>
                                <div class="form-group">
                                    <label>Payment Mode *</label>
                                    <select id="paymentMode" required>
                                        <option value="cash">Cash</option>
                                        <option value="upi">UPI</option>
                                        <option value="card">Card</option>
                                        <option value="netbanking">Net Banking</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Payment Date *</label>
                                    <input type="date" id="paymentDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Transaction ID (Optional)</label>
                                    <input type="text" id="transactionId" placeholder="For online payments">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="paymentNotes" rows="2" placeholder="Add any notes"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">üí∞ Collect Payment</button>
                            <button type="button" class="btn" onclick="hideCollectFee()">Cancel</button>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="month" id="filterMonth" placeholder="Filter by month">
                        <select id="filterPaymentMode">
                            <option value="">All Payment Modes</option>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                            <option value="card">Card</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Receipt No</th><th>Date</th><th>Student</th><th>Month</th>
                                    <th>Amount</th><th>Mode</th><th>Transaction ID</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="feesTable">
                                <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BATCHES VIEW -->
            <div id="batchesView" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2>üìö Batch Management</h2>
                        <button class="btn btn-primary" onclick="showAddBatch()">+ Create Batch</button>
                    </div>

                    <div id="addBatchForm" class="form-section">
                        <h3>Create New Batch</h3>
                        <form id="batchForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Batch Name *</label>
                                    <input type="text" id="batchName" required placeholder="e.g., Class 11 Morning">
                                </div>
                                <div class="form-group">
                                    <label>Class *</label>
                                    <select id="batchClass" required>
                                        <option value="">Select Class</option>
                                        <option value="11">Class 11</option>
                                        <option value="12">Class 12</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" id="batchStartTime">
                                </div>
                                <div class="form-group">
                                    <label>End Time</label>
                                    <input type="time" id="batchEndTime">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Days</label>
                                <input type="text" id="batchDays" placeholder="e.g., Mon, Wed, Fri">
                            </div>
                            <button type="submit" class="btn btn-success">üìö Create Batch</button>
                            <button type="button" class="btn" onclick="hideAddBatch()">Cancel</button>
                        </form>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Batch ID</th><th>Batch Name</th><th>Class</th>
                                    <th>Timing</th><th>Days</th><th>Students</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batchesTable">
                                <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ATTENDANCE VIEW -->
            <div id="attendanceView" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2>üìÖ Attendance Management</h2>
                        <button class="btn btn-primary" onclick="showMarkAttendance()">‚úì Mark Attendance</button>
                    </div>

                    <div id="markAttendanceForm" class="form-section">
                        <h3>Mark Today's Attendance</h3>
                        <form id="attendanceForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" id="attendanceDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Batch *</label>
                                    <select id="attendanceBatch" required onchange="loadBatchStudentsForAttendance()">
                                        <option value="">Select Batch</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="attendanceStudentsList" style="margin-top: 20px;"></div>
                            
                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">üíæ Save Attendance</button>
                                <button type="button" class="btn" onclick="hideMarkAttendance()">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="filters">
                        <input type="date" id="filterAttendanceDate">
                        <select id="filterAttendanceBatch">
                            <option value="">All Batches</option>
                        </select>
                        <button class="btn btn-info" onclick="filterAttendance()">üîç Search</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Student Name</th><th>Batch</th>
                                    <th>Status</th><th>Marked By</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable">
                                <tr><td colspan="5" style="text-align:center;">Select date and batch to view attendance</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ENQUIRIES VIEW -->
            <div id="enquiriesView" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2>üìû Student Enquiries</h2>
                        <button class="btn btn-primary" onclick="showAddEnquiry()">+ Add Enquiry</button>
                    </div>

                    <div id="addEnquiryForm" class="form-section">
                        <h3>Add New Enquiry</h3>
                        <form id="enquiryForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Student Name *</label>
                                    <input type="text" id="enquiryName" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone Number *</label>
                                    <input type="tel" id="enquiryPhone" required pattern="[0-9]{10}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Class Interested *</label>
                                    <select id="enquiryClass" required>
                                        <option value="">Select Class</option>
                                        <option value="11">Class 11</option>
                                        <option value="12">Class 12</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Source</label>
                                    <select id="enquirySource">
                                        <option value="website">Website</option>
                                        <option value="referral">Referral</option>
                                        <option value="walkin">Walk-in</option>
                                        <option value="social">Social Media</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="enquiryNotes" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">üíæ Save Enquiry</button>
                            <button type="button" class="btn" onclick="hideAddEnquiry()">Cancel</button>
                        </form>
                    </div>

                    <div class="filters">
                        <select id="filterEnquiryStatus">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="converted">Converted</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Name</th><th>Phone</th><th>Class</th>
                                    <th>Source</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enquiriesTable">
                                <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA84o3QgzqsL_HJwkEL2-TLDQAzkxHhjO4",
            authDomain: "commerce-gyan.firebaseapp.com",
            projectId: "commerce-gyan",
            storageBucket: "commerce-gyan.firebasestorage.app",
            messagingSenderId: "1034104845810",
            appId: "1:1034104845810:web:c356c101a983328f80676b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allStudents = [];
        let allFees = [];
        let allBatches = [];
        let allEnquiries = [];
        let allAttendance = [];
        let currentUser = null;

        // Auth Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                loadAllData();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboardPage').style.display = 'none';
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorMsg.textContent = 'Invalid credentials. Please check email and password.';
                errorMsg.style.display = 'block';
            }
        });

        // Logout
        window.logout = async () => {
            if(confirm('Are you sure you want to logout?')) {
                await signOut(auth);
            }
        };

        // Load All Data
        async function loadAllData() {
            try {
                await Promise.all([
                    loadStudents(),
                    loadFees(),
                    loadBatches(),
                    loadEnquiries(),
                    loadAttendance()
                ]);
                updateDashboard();
                populateDropdowns();
            } catch (error) {
                console.error('Error loading ', error);
                alert('Error loading data. Please refresh the page.');
            }
        }

        // Load Students
        async function loadStudents() {
            try {
                const snapshot = await getDocs(query(collection(db, 'students'), orderBy('created_at', 'desc')));
                allStudents = [];
                snapshot.forEach(doc => allStudents.push({ id: doc.id, ...doc.data() }));
                displayStudents();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load Fees
        async function loadFees() {
            try {
                const snapshot = await getDocs(query(collection(db, 'fees'), orderBy('created_at', 'desc')));
                allFees = [];
                snapshot.forEach(doc => allFees.push({ id: doc.id, ...doc.data() }));
                displayFees();
            } catch (error) {
                console.error('Error loading fees:', error);
            }
        }

        // Load Batches
        async function loadBatches() {
            try {
                const snapshot = await getDocs(collection(db, 'batches'));
                allBatches = [];
                snapshot.forEach(doc => allBatches.push({ id: doc.id, ...doc.data() }));
                displayBatches();
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        // Load Enquiries
        async function loadEnquiries() {
            try {
                const snapshot = await getDocs(query(collection(db, 'enquiries'), orderBy('created_at', 'desc')));
                allEnquiries = [];
                snapshot.forEach(doc => allEnquiries.push({ id: doc.id, ...doc.data() }));
                displayEnquiries();
            } catch (error) {
                console.error('Error loading enquiries:', error);
            }
        }

        // Load Attendance
        async function loadAttendance() {
            try {
                const snapshot = await getDocs(query(collection(db, 'Attendance'), orderBy('created_at', 'desc'), limit(100)));
                allAttendance = [];
                snapshot.forEach(doc => allAttendance.push({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        // Update Dashboard
        function updateDashboard() {
            document.getElementById('totalStudents').textContent = allStudents.length;
            
            const totalRevenue = allFees.reduce((sum, fee) => sum + (fee.amount || 0), 0);
            document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            
            const pendingFees = allStudents.reduce((sum, s) => sum + (s.balance_due || 0), 0);
            document.getElementById('pendingFees').textContent = `‚Çπ${pendingFees.toLocaleString()}`;
            
            document.getElementById('totalBatches').textContent = allBatches.length;

            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthFees = allFees.filter(f => f.payment_date && f.payment_date.startsWith(currentMonth));
            const monthCollection = monthFees.reduce((sum, fee) => sum + (fee.amount || 0), 0);
            document.getElementById('monthCollection').textContent = `‚Çπ${monthCollection.toLocaleString()}`;

            const defaulters = allStudents.filter(s => (s.balance_due || 0) > 0);
            document.getElementById('defaultersCount').textContent = defaulters.length;

            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const newEnq = allEnquiries.filter(e => {
                const created = new Date(e.created_at);
                return created >= weekAgo;
            });
            document.getElementById('newEnquiries').textContent = newEnq.length;

            displayRecentStudents();
        }

        function displayRecentStudents() {
            const tbody = document.querySelector('#recentStudentsTable');
            tbody.innerHTML = '';
            const recent = allStudents.slice(0, 5);
            
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No students yet</td></tr>';
            } else {
                recent.forEach(s => {
                    const balance = s.balance_due || 0;
                    const balanceColor = balance > 0 ? '#ef4444' : '#10b981';
                    tbody.innerHTML += `<tr>
                        <td>${s.student_id || 'N/A'}</td>
                        <td><strong>${s.name || 'N/A'}</strong></td>
                        <td>${s.phone || 'N/A'}</td>
                        <td>Class ${s.class || 'N/A'}</td>
                        <td style="color:${balanceColor}; font-weight:600;">‚Çπ${balance}</td>
                        <td><span class="badge badge-success">Active</span></td>
                    </tr>`;
                });
            }
        }

        // Display Students
        function displayStudents() {
            const tbody = document.querySelector('#studentsTable');
            tbody.innerHTML = '';
            
            let filtered = [...allStudents];
            
            const searchTerm = document.getElementById('searchStudent')?.value.toLowerCase() || '';
            const classFilter = document.getElementById('filterClass')?.value || '';
            const batchFilter = document.getElementById('filterBatch')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            
            if(searchTerm) {
                filtered = filtered.filter(s => 
                    s.name?.toLowerCase().includes(searchTerm) || 
                    s.phone?.includes(searchTerm)
                );
            }
            if(classFilter) filtered = filtered.filter(s => s.class === classFilter);
            if(batchFilter) filtered = filtered.filter(s => s.batch_id === batchFilter);
            if(statusFilter) filtered = filtered.filter(s => s.status === statusFilter);
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No students found</td></tr>';
            } else {
                filtered.forEach(s => {
                    const batch = allBatches.find(b => b.id === s.batch_id);
                    const balance = s.balance_due || 0;
                    const status = s.status || 'active';
                    
                    tbody.innerHTML += `<tr>
                        <td>${s.student_id || 'N/A'}</td>
                        <td><strong>${s.name || 'N/A'}</strong></td>
                        <td>${s.phone || 'N/A'}</td>
                        <td>Class ${s.class || 'N/A'}</td>
                        <td>${batch?.name || 'Not Assigned'}</td>
                        <td>‚Çπ${s.monthly_fee || 0}</td>
                        <td style="color:${balance > 0 ? '#ef4444' : '#10b981'}; font-weight:600;">‚Çπ${balance}</td>
                        <td><span class="badge badge-${status === 'active' ? 'success' : 'warning'}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}', '${s.name}')">üóëÔ∏è</button>
                            <button class="btn btn-sm btn-primary" onclick="window.open('https://wa.me/91${s.phone}', '_blank')">üì±</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // Display Fees
        function displayFees() {
            const tbody = document.querySelector('#feesTable');
            tbody.innerHTML = '';
            
            let filtered = [...allFees];
            
            const monthFilter = document.getElementById('filterMonth')?.value || '';
            const modeFilter = document.getElementById('filterPaymentMode')?.value || '';
            
            if(monthFilter) filtered = filtered.filter(f => f.month === monthFilter);
            if(modeFilter) filtered = filtered.filter(f => f.payment_mode === modeFilter);
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No payments yet</td></tr>';
            } else {
                filtered.forEach(f => {
                    const student = allStudents.find(s => s.id === f.student_id);
                    const date = f.payment_date || f.created_at || '';
                    const displayDate = date ? new Date(date).toLocaleDateString('en-IN') : 'N/A';
                    
                    tbody.innerHTML += `<tr>
                        <td><strong>${f.receipt_no || 'N/A'}</strong></td>
                        <td>${displayDate}</td>
                        <td>${student?.name || 'Unknown'}</td>
                        <td>${f.month || 'N/A'}</td>
                        <td style="color:#10b981; font-weight:600;">‚Çπ${f.amount || 0}</td>
                        <td><span class="badge badge-info">${f.payment_mode || 'Cash'}</span></td>
                        <td>${f.transaction_id || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="shareReceipt('${student?.phone}', '${f.receipt_no}', '${student?.name}', '${f.amount}')">üì± Share</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // Display Batches
        function displayBatches() {
            const tbody = document.querySelector('#batchesTable');
            tbody.innerHTML = '';
            
            if (allBatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No batches created yet</td></tr>';
            } else {
                allBatches.forEach(b => {
                    const studentCount = allStudents.filter(s => s.batch_id === b.id).length;
                    const timing = `${b.start_time || ''} - ${b.end_time || ''}`;
                    
                    tbody.innerHTML += `<tr>
                        <td>${b.batch_id || b.id.slice(0,8)}</td>
                        <td><strong>${b.name || 'N/A'}</strong></td>
                        <td>Class ${b.class || 'N/A'}</td>
                        <td>${timing}</td>
                        <td>${b.days || 'N/A'}</td>
                        <td>${studentCount}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteBatch('${b.id}', '${b.name}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // Display Enquiries
        function displayEnquiries() {
            const tbody = document.querySelector('#enquiriesTable');
            tbody.innerHTML = '';
            
            let filtered = [...allEnquiries];
            const statusFilter = document.getElementById('filterEnquiryStatus')?.value || '';
            if(statusFilter) filtered = filtered.filter(e => e.status === statusFilter);
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No enquiries yet</td></tr>';
            } else {
                filtered.forEach(e => {
                    const date = new Date(e.created_at).toLocaleDateString('en-IN');
                    const status = e.status || 'new';
                    const badgeClass = status === 'converted' ? 'success' : status === 'lost' ? 'danger' : 'warning';
                    
                    tbody.innerHTML += `<tr>
                        <td>${date}</td>
                        <td><strong>${e.name || 'N/A'}</strong></td>
                        <td>${e.phone || 'N/A'}</td>
                        <td>Class ${e.class || 'N/A'}</td>
                        <td>${e.source || 'N/A'}</td>
                        <td><span class="badge badge-${badgeClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="convertEnquiry('${e.id}')">‚úì Convert</button>
                            <button class="btn btn-sm btn-primary" onclick="window.open('https://wa.me/91${e.phone}', '_blank')">üì±</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEnquiry('${e.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // Populate Dropdowns
        function populateDropdowns() {
            const batchSelects = document.querySelectorAll('#studentBatch, #filterBatch, #attendanceBatch, #filterAttendanceBatch');
            batchSelects.forEach(select => {
                const currentValue = select.value;
                const isFilter = select.id.includes('filter') || select.id === 'filterAttendanceBatch';
                select.innerHTML = isFilter ? '<option value="">All Batches</option>' : '<option value="">Select Batch</option>';
                allBatches.forEach(b => {
                    select.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
                if(currentValue) select.value = currentValue;
            });

            const studentSelect = document.getElementById('feeStudentId');
            if(studentSelect) {
                studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                allStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.id}">${s.name} - ${s.phone} (‚Çπ${s.monthly_fee || 0})</option>`;
                });
            }
        }

        // View Navigation
        window.showView = (viewName) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            event.target.classList.add('active');
        };

        // Student Functions
        window.showAddStudent = () => {
            document.getElementById('addStudentForm').style.display = 'block';
            document.getElementById('admissionDate').valueAsDate = new Date();
        };
        window.hideAddStudent = () => {
            document.getElementById('addStudentForm').style.display = 'none';
            document.getElementById('studentForm').reset();
        };

        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentData = {
                student_id: 'CG' + Date.now().toString().slice(-6),
                name: document.getElementById('studentName').value,
                phone: document.getElementById('studentPhone').value,
                parent_name: document.getElementById('parentName').value || '',
                parent_phone: document.getElementById('parentPhone').value || '',
                class: document.getElementById('studentClass').value,
                batch_id: document.getElementById('studentBatch').value || '',
                monthly_fee: parseInt(document.getElementById('monthlyFee').value),
                admission_date: document.getElementById('admissionDate').value,
                address: document.getElementById('studentAddress').value || '',
                balance_due: 0,
                status: 'active',
                created_at: new Date().toISOString(),
                created_by: currentUser.email
            };

            try {
                await addDoc(collection(db, 'students'), studentData);
                alert('‚úÖ Student added successfully!');
                hideAddStudent();
                await loadStudents();
                updateDashboard();
                populateDropdowns();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        window.deleteStudent = (id, name) => {
            if(confirm(`Are you sure you want to delete student: ${name}?`)) {
                deleteDoc(doc(db, 'students', id)).then(() => {
                    alert('‚úÖ Student deleted');
                    loadStudents();
                    updateDashboard();
                }).catch(err => alert('‚ùå Error: ' + err.message));
            }
        };

        // Search & Filter
        document.getElementById('searchStudent')?.addEventListener('input', displayStudents);
        document.getElementById('filterClass')?.addEventListener('change', displayStudents);
        document.getElementById('filterBatch')?.addEventListener('change', displayStudents);
        document.getElementById('filterStatus')?.addEventListener('change', displayStudents);

        // Fee Functions
        window.showCollectFee = () => {
            document.getElementById('collectFeeForm').style.display = 'block';
            document.getElementById('paymentDate').valueAsDate = new Date();
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('feeMonth').value = currentMonth;
        };
        window.hideCollectFee = () => {
            document.getElementById('collectFeeForm').style.display = 'none';
            document.getElementById('feeForm').reset();
        };

        window.fillStudentFee = () => {
            const studentId = document.getElementById('feeStudentId').value;
            const student = allStudents.find(s => s.id === studentId);
            if(student) {
                document.getElementById('feeAmount').value = student.monthly_fee || 0;
            }
        };

        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('feeStudentId').value;
            const amount = parseInt(document.getElementById('feeAmount').value);
            const receiptNo = 'RCP' + Date.now().toString().slice(-8);

            const feeData = {
                student_id: studentId,
                amount: amount,
                month: document.getElementById('feeMonth').value,
                payment_date: document.getElementById('paymentDate').value,
                payment_mode: document.getElementById('paymentMode').value,
                transaction_id: document.getElementById('transactionId').value || '',
                notes: document.getElementById('paymentNotes').value || '',
                receipt_no: receiptNo,
                status: 'paid',
                created_at: new Date().toISOString(),
                created_by: currentUser.email
            };

            try {
                await addDoc(collection(db, 'fees'), feeData);
                
                const student = allStudents.find(s => s.id === studentId);
                if(student) {
                    const newBalance = (student.balance_due || 0) - amount;
                    await updateDoc(doc(db, 'students', studentId), {
                        balance_due: newBalance < 0 ? 0 : newBalance,
                        last_payment_date: feeData.payment_date
                    });
                }

                alert('‚úÖ Payment collected!\nReceipt No: ' + receiptNo);
                hideCollectFee();
                await loadFees();
                await loadStudents();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        window.shareReceipt = (phone, receiptNo, name, amount) => {
            const msg = `üßæ *Fee Receipt*\n\nReceipt No: ${receiptNo}\nStudent: ${name}\nAmount: ‚Çπ${amount}\n\nPayment received successfully.\n\nThank you!\n*Commerce Gyan*\nüìû 9278569860`;
            window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        document.getElementById('filterMonth')?.addEventListener('change', displayFees);
        document.getElementById('filterPaymentMode')?.addEventListener('change', displayFees);

        // Batch Functions
        window.showAddBatch = () => {
            document.getElementById('addBatchForm').style.display = 'block';
        };
        window.hideAddBatch = () => {
            document.getElementById('addBatchForm').style.display = 'none';
            document.getElementById('batchForm').reset();
        };

        document.getElementById('batchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const batchData = {
                batch_id: 'B' + Date.now().toString().slice(-6),
                name: document.getElementById('batchName').value,
                class: document.getElementById('batchClass').value,
                start_time: document.getElementById('batchStartTime').value || '',
                end_time: document.getElementById('batchEndTime').value || '',
                days: document.getElementById('batchDays').value || '',
                student_count: 0,
                status: 'active',
                created_at: new Date().toISOString(),
                created_by: currentUser.email
            };

            try {
                await addDoc(collection(db, 'batches'), batchData);
                alert('‚úÖ Batch created successfully!');
                hideAddBatch();
                await loadBatches();
                populateDropdowns();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        window.deleteBatch = (id, name) => {
            if(confirm(`Delete batch: ${name}?`)) {
                deleteDoc(doc(db, 'batches', id)).then(() => {
                    alert('‚úÖ Batch deleted');
                    loadBatches();
                    populateDropdowns();
                }).catch(err => alert('‚ùå Error: ' + err.message));
            }
        };

        // Attendance Functions - FIXED VERSION
        window.showMarkAttendance = () => {
            document.getElementById('markAttendanceForm').style.display = 'block';
            document.getElementById('attendanceDate').valueAsDate = new Date();
            document.getElementById('attendanceStudentsList').innerHTML = '<p style="padding:20px; text-align:center; color:#666;">Please select a batch to see students</p>';
        };
        
        window.hideMarkAttendance = () => {
            document.getElementById('markAttendanceForm').style.display = 'none';
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceStudentsList').innerHTML = '';
        };

        window.loadBatchStudentsForAttendance = () => {
            const batchId = document.getElementById('attendanceBatch').value;
            const container = document.getElementById('attendanceStudentsList');
            
            console.log('Loading students for batch:', batchId);
            console.log('All students:', allStudents);
            
            if(!batchId) {
                container.innerHTML = '<p style="padding:20px; text-align:center; color:#666;">Please select a batch</p>';
                return;
            }

            const students = allStudents.filter(s => s.batch_id === batchId && s.status === 'active');
            
            console.log('Filtered students:', students);
            
            if(students.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è No students found in this batch</strong><br>
                        Please assign students to this batch first from the Students section.
                    </div>
                `;
                return;
            }

            container.innerHTML = '<h4 style="margin-bottom:15px; color:#333;">Mark Attendance for ' + students.length + ' Students:</h4>';
            
            students.forEach(s => {
                container.innerHTML += `
                    <div class="attendance-student-item">
                        <div>
                            <div class="attendance-student-name">${s.name}</div>
                            <div class="attendance-student-phone">üì± ${s.phone}</div>
                        </div>
                        <div class="attendance-radio-group">
                            <label>
                                <input type="radio" name="att_${s.id}" value="present" checked> 
                                ‚úì Present
                            </label>
                            <label>
                                <input type="radio" name="att_${s.id}" value="absent"> 
                                ‚úó Absent
                            </label>
                        </div>
                    </div>
                `;
            });
        };

        document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const batchId = document.getElementById('attendanceBatch').value;
            const date = document.getElementById('attendanceDate').value;
            
            if(!batchId) {
                alert('Please select a batch');
                return;
            }
            
            const students = allStudents.filter(s => s.batch_id === batchId && s.status === 'active');

            if(students.length === 0) {
                alert('No students in this batch');
                return;
            }

            try {
                for(const student of students) {
                    const statusElement = document.querySelector(`input[name="att_${student.id}"]:checked`);
                    const status = statusElement ? statusElement.value : 'present';
                    
                    await addDoc(collection(db, 'Attendance'), {
                        attendance_id: 'ATT' + Date.now().toString().slice(-8),
                        student_id: student.id,
                        student_name: student.name,
                        batch_id: batchId,
                        attendance_date: date,
                        status: status,
                        created_at: new Date().toISOString(),
                        marked_by: currentUser.email
                    });
                }

                alert('‚úÖ Attendance marked successfully for ' + students.length + ' students!');
                hideMarkAttendance();
                await loadAttendance();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                console.error('Attendance error:', error);
            }
        });

        window.filterAttendance = async () => {
            const date = document.getElementById('filterAttendanceDate').value;
            const batchId = document.getElementById('filterAttendanceBatch').value;

            if(!date) {
                alert('Please select a date');
                return;
            }

            const tbody = document.querySelector('#attendanceTable');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';

            let filtered = allAttendance.filter(a => a.attendance_date === date);
            if(batchId) filtered = filtered.filter(a => a.batch_id === batchId);

            tbody.innerHTML = '';
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No attendance records found for this date</td></tr>';
            } else {
                filtered.forEach(a => {
                    const batch = allBatches.find(b => b.id === a.batch_id);
                    const statusBadge = a.status === 'present' ? 'success' : 'danger';
                    
                    tbody.innerHTML += `<tr>
                        <td>${a.attendance_date}</td>
                        <td>${a.student_name}</td>
                        <td>${batch?.name || 'N/A'}</td>
                        <td><span class="badge badge-${statusBadge}">${a.status}</span></td>
                        <td>${a.marked_by || 'Admin'}</td>
                    </tr>`;
                });
            }
        };

        // Enquiry Functions
        window.showAddEnquiry = () => {
            document.getElementById('addEnquiryForm').style.display = 'block';
        };
        window.hideAddEnquiry = () => {
            document.getElementById('addEnquiryForm').style.display = 'none';
            document.getElementById('enquiryForm').reset();
        };

        document.getElementById('enquiryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const enquiryData = {
                name: document.getElementById('enquiryName').value,
                phone: document.getElementById('enquiryPhone').value,
                class: document.getElementById('enquiryClass').value,
                source: document.getElementById('enquirySource').value,
                notes: document.getElementById('enquiryNotes').value || '',
                status: 'new',
                created_at: new Date().toISOString(),
                created_by: currentUser.email
            };

            try {
                await addDoc(collection(db, 'enquiries'), enquiryData);
                alert('‚úÖ Enquiry added successfully!');
                hideAddEnquiry();
                await loadEnquiries();
                updateDashboard();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        window.convertEnquiry = async (id) => {
            const enquiry = allEnquiries.find(e => e.id === id);
            if(!enquiry) return;
            
            if(confirm(`Convert "${enquiry.name}" to student?\n\nNote: You'll need to add remaining details (fee, batch, etc.) from Students section.`)) {
                try {
                    await updateDoc(doc(db, 'enquiries', id), { 
                        status: 'converted',
                        converted_at: new Date().toISOString()
                    });
                    alert('‚úÖ Enquiry marked as converted!\n\nNow go to Students tab to add full details.');
                    loadEnquiries();
                    updateDashboard();
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            }
        };

        window.deleteEnquiry = (id) => {
            if(confirm('Delete this enquiry?')) {
                deleteDoc(doc(db, 'enquiries', id)).then(() => {
                    alert('‚úÖ Enquiry deleted');
                    loadEnquiries();
                    updateDashboard();
                }).catch(err => alert('‚ùå Error: ' + err.message));
            }
        };

        document.getElementById('filterEnquiryStatus')?.addEventListener('change', displayEnquiries);
    </script>
</body>
</html>
